<form class="{{cssClass}} {{actor.type}} flexcol" autocomplete="off">

  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
    <div class="header-fields">
      <h1 class="charname"><input name="name" type="text" value="{{actor.name}}" placeholder="Name"/></h1>
      <div class="resources grid grid-3col">

        <div class="resource flex-group-center">
          <label for="system.health.value" class="resource-label">Health</label>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="number" name="system.health.value" value="{{system.health.value}}" min="0"/>
            <span> / {{system.health.max}}</span>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.mana.value" class="resource-label">Mana</label>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="number" name="system.mana.value" value="{{system.mana.value}}" min="0"/>
            <span> / {{system.mana.max}}</span>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.stamina.value" class="resource-label">Stamina</label>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="number" name="system.stamina.value" value="{{system.stamina.value}}" min="0"/>
            <span> / {{system.stamina.max}}</span>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.attributes.class.level" class="resource-label">Class Level</label>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="number" name="system.attributes.class.level" value="{{system.attributes.class.level}}" min="0"/>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.attributes.race.level" class="resource-label">Race Level</label>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="number" name="system.attributes.race.level" value="{{system.attributes.race.level}}" min="0"/>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.attributes.profession.level" class="resource-label">Profession Level</label>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="number" name="system.attributes.profession.level" value="{{system.attributes.profession.level}}" min="0"/>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.attributes.class.name" class="resource-label">Class</label>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="text" name="system.attributes.class.name" value="{{system.attributes.class.name}}" data-dtype="String"/>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.attributes.race.name" class="resource-label">Race</label>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="text" name="system.attributes.race.name" value="{{system.attributes.race.name}}" data-dtype="String"/>
                        <span class="resource-label flex-center flex-between">Rank</span>
            <input type="text" name="system.attributes.race.rank" value="{{system.attributes.race.rank}}" data-dtype="String"/>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.attributes.profession.name" class="resource-label">Profession</label>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="text" name="system.attributes.profession.name" value="{{system.attributes.profession.name}}" data-dtype="String"/>
          </div>
        </div>
      </div>
      <div class="resources grid grid-6col">
        <div class="resource flex-group-center">
          <label class="resource-label">Armor</label>
          <div class="resource-content flexrow flex-center flex-between">
            <span>{{system.defense.armor.value}}</span>
          </div>
        </div>
        <div class="resource flex-group-center">
          <label class="resource-label">Veil</label>
          <div class="resource-content flexrow flex-center flex-between">
            <span>{{system.defense.veil.value}}</span>
          </div>
        </div>
        <div class="resource flex-group-center">
          <label for="system.defense.melee.value" class="resource-label">Melee Defense</label>
          <div class="resource-content flexrow flex-center flex-between">
            <span>{{system.defense.melee.value}}</span>
          </div>
        </div>
        <div class="resource flex-group-center">
          <label for="system.defense.ranged.value" class="resource-label">Ranged Defense</label>
          <div class="resource-content flexrow flex-center flex-between">
            <span>{{system.defense.ranged.value}}</span>
          </div>
        </div>
        <div class="resource flex-group-center">
          <label for="system.defense.mind.value" class="resource-label">Mind Defense</label>
          <div class="resource-content flexrow flex-center flex-between">
            <span>{{system.defense.mind.value}}</span>
          </div>
        </div>
        <div class="resource flex-group-center">
          <label for="system.defense.soul.value" class="resource-label">Soul Defense</label>
          <div class="resource-content flexrow flex-center flex-between">
            <span>{{system.defense.soul.value}}</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="features">Features</a>
    <a class="item" data-tab="stats">Stats</a>
    <a class="item" data-tab="equipment">{{localize "ASPECTSOFPOWER.Equip.tabLabel"}}</a>
    <a class="item" data-tab="description">Description</a>
    <a class="item" data-tab="items">Items</a>
    <a class="item" data-tab="skills">Skills</a>
    <a class="item" data-tab="effects">Effects</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Owned Features Tab --}}
    <div class="tab features" data-group="primary" data-tab="features">
      <section class="grid grid-3col">
        <aside class="sidebar">

          <div class="abilities flexcol">
            {{#each system.abilities as |ability key|}}
            <div class="ability flexrow flex-group-center">
              <label for="system.abilities.{{key}}.value" class="resource-label rollable flexlarge align-left" data-roll="(d20/100)*@abilities.{{key}}.mod+@abilities.{{key}}.mod" data-label="{{localize (lookup @root.config.abilities key)}}">{{localize (lookup @root.config.abilities key)}}</label>
              <input type="number" name="system.abilities.{{key}}.value" value="{{ability.value}}" min="0"/>
              <span class="stat-mod rollable" data-roll="(d20/100)*@abilities.{{key}}.mod+@abilities.{{key}}.mod" data-label="{{localize (lookup @root.config.abilities key)}}">{{numberFormat ability.mod decimals=0 sign=true}}</span>
            </div>
            {{/each}}
          </div>
        </aside>

        <section class="main grid-span-2">
          {{> "systems/aspects-of-power/templates/actor/parts/actor-skills.hbs"}}
        </section>

      </section>
    </div>

    {{!-- Stats Tab --}}
    <div class="tab stats" data-group="primary" data-tab="stats">
      <div class="stats-breakdown">

        {{!-- Summary --}}
        <div class="stats-summary flexrow">
          <span>{{localize "ASPECTSOFPOWER.Stats.totalCalculated"}}: {{statsSummary.totalCalculated}}</span>
          <span>{{localize "ASPECTSOFPOWER.Stats.globalEquipCap"}}: {{statsSummary.globalCap}}</span>
          <span>{{localize "ASPECTSOFPOWER.Stats.equipmentUsed"}}: {{statsSummary.totalEquipCapped}} / {{statsSummary.totalEquipRaw}}</span>
        </div>

        {{!-- Column headers --}}
        <div class="stat-header flexrow">
          <span class="stat-col-name">{{localize "ASPECTSOFPOWER.AttributeGroup.abilities"}}</span>
          <span class="stat-col">{{localize "ASPECTSOFPOWER.Stats.base"}}</span>
          <span class="stat-col">{{localize "ASPECTSOFPOWER.Stats.calculated"}}</span>
          <span class="stat-col">{{localize "ASPECTSOFPOWER.Stats.equipmentBonus"}}</span>
          <span class="stat-col">{{localize "ASPECTSOFPOWER.Stats.equipmentCap"}}</span>
          <span class="stat-col">{{localize "ASPECTSOFPOWER.Stats.effectBonus"}}</span>
          <span class="stat-col">{{localize "ASPECTSOFPOWER.Stats.withEquipment"}}</span>
          <span class="stat-col">{{localize "ASPECTSOFPOWER.Stats.finalMod"}}</span>
        </div>

        {{!-- One row per ability --}}
        <div class="stat-list">
          {{#each system.abilities as |ability key|}}
          <div class="stat-row flexrow">
            <label class="stat-col-name rollable"
                   data-roll="(d20/100)*@abilities.{{key}}.mod+@abilities.{{key}}.mod"
                   data-label="{{localize (lookup @root.config.abilities key)}}">
              {{localize (lookup @root.config.abilities key)}}
            </label>
            <span class="stat-col">
              <input type="number" name="system.abilities.{{key}}.value"
                     value="{{ability.breakdown.base}}" min="0" class="stat-input"/>
            </span>
            <span class="stat-col">{{ability.breakdown.calculated}}</span>
            {{#if (gt ability.breakdown.equipmentBonusRaw ability.breakdown.equipmentCapped)}}
              <span class="stat-col capped">
                {{ability.breakdown.equipmentCapped}}
                <span class="raw-value">({{ability.breakdown.equipmentBonusRaw}})</span>
              </span>
            {{else}}
              <span class="stat-col">{{ability.breakdown.equipmentCapped}}</span>
            {{/if}}
            <span class="stat-col">{{ability.breakdown.perStatCap}}</span>
            <span class="stat-col">{{ability.breakdown.effectBonus}}</span>
            <span class="stat-col stat-total"><strong>{{ability.breakdown.final}}</strong></span>
            <span class="stat-col stat-mod rollable"
                  data-roll="(d20/100)*@abilities.{{key}}.mod+@abilities.{{key}}.mod"
                  data-label="{{localize (lookup @root.config.abilities key)}}">
              {{numberFormat ability.breakdown.finalMod decimals=0 sign=true}}
            </span>
          </div>
          {{/each}}
        </div>

        {{!-- Ranges --}}
        <div class="stats-ranges flexrow">
          <span class="range-item">
            <strong>{{localize "ASPECTSOFPOWER.Range.castingRange"}}:</strong> {{system.castingRange}} ft
          </span>
          <span class="range-item">
            <strong>{{localize "ASPECTSOFPOWER.Range.walkRange"}}:</strong> {{system.walkRange}} ft
          </span>
          <span class="range-item">
            <strong>{{localize "ASPECTSOFPOWER.Range.sprintRange"}}:</strong> {{system.sprintRange}} ft
          </span>
        </div>

      </div>
    </div>

    {{!-- Equipment Tab --}}
    <div class="tab equipment" data-group="primary" data-tab="equipment">
      <div class="equipment-tab">

        {{!-- Carrying Capacity --}}
        <div class="carry-summary flexrow">
          <span class="carry-label">
            <strong>{{localize "ASPECTSOFPOWER.Equip.carryCapacity"}}:</strong>
            {{system.carryWeight}} / {{system.carryCapacity}}
            {{#if system.encumbered}}
              <span class="encumbered-warn">{{localize "ASPECTSOFPOWER.Equip.encumbered"}}</span>
            {{/if}}
          </span>
          <div class="carry-bar-outer">
            <div class="carry-bar-inner {{#if system.encumbered}}over-capacity{{/if}}"
                 style="width: {{carryPercent}}%"></div>
          </div>
        </div>

        {{!-- Equipment Slots --}}
        <div class="equip-slots">
          {{#each equipmentSlots as |slotData slotKey|}}
            <div class="slot-group">
              <div class="slot-header flexrow">
                <strong>{{slotData.label}}</strong>
                <span class="slot-count">({{slotData.items.length}} / {{slotData.max}})</span>
              </div>
              {{#if slotData.items.length}}
                {{#each slotData.items as |item|}}
                  <div class="item equipped-item flexrow" data-item-id="{{item._id}}">
                    <div class="item-image">
                      <img src="{{item.img}}" title="{{item.name}}" width="24" height="24" />
                    </div>
                    <span class="item-name">
                      <h4 class="equip-item-name" style="color: {{item.rarityColor}}">{{item.name}}</h4>
                    </span>
                    <span class="durability-display">
                      <span class="durability-bar-outer">
                        <span class="durability-bar-inner" style="width: {{item.durabilityPercent}}%"></span>
                      </span>
                      <span class="durability-text">{{item.system.durability.value}}/{{item.system.durability.max}}</span>
                    </span>
                    <div class="item-controls">
                      {{#if (lt item.system.durability.value item.system.durability.max)}}
                        <a class="repair-item" title="{{localize 'ASPECTSOFPOWER.Equip.repair'}}">
                          <i class="fas fa-wrench"></i>
                        </a>
                      {{/if}}
                      <a class="equip-toggle" title="{{localize 'ASPECTSOFPOWER.Equip.unequip'}}">
                        <i class="fas fa-shield-alt"></i>
                      </a>
                      <a class="item-edit" title="{{localize 'DOCUMENT.Update' type='Item'}}">
                        <i class="fas fa-edit"></i>
                      </a>
                    </div>
                  </div>
                {{/each}}
              {{else}}
                <div class="slot-empty">â€”</div>
              {{/if}}
            </div>
          {{/each}}
        </div>

        {{!-- Unequipped Inventory --}}
        <div class="unequipped-section">
          <div class="items-header flexrow">
            <span class="item-name">{{localize "ASPECTSOFPOWER.Equip.unequipped"}}</span>
            <span class="item-prop equip-col-weight">{{localize "ASPECTSOFPOWER.Equip.weight"}}</span>
            <span class="item-prop equip-col-qty">{{localize "ASPECTSOFPOWER.Equip.quantity"}}</span>
            <div class="item-controls">
              <a class="item-control item-create" title="{{localize 'DOCUMENT.Create' type='Item'}}" data-type="item">
                <i class="fas fa-plus"></i> {{localize "DOCUMENT.New" type="item"}}
              </a>
            </div>
          </div>
          {{#each unequippedGear as |item|}}
            <div class="item unequipped-item flexrow" data-item-id="{{item._id}}">
              <div class="item-name">
                <div class="item-image">
                  <img src="{{item.img}}" title="{{item.name}}" width="24" height="24" />
                </div>
                <h4 style="color: {{item.rarityColor}}">{{item.name}}</h4>
              </div>
              <span class="item-prop equip-col-weight">{{item.system.weight}}</span>
              <span class="item-prop equip-col-qty">{{item.system.quantity}}</span>
              <div class="item-controls">
                {{#if item.system.slot}}
                  <a class="equip-toggle" title="{{localize 'ASPECTSOFPOWER.Equip.equip'}}">
                    <i class="fas fa-arrow-up"></i>
                  </a>
                {{/if}}
                <a class="item-edit" title="{{localize 'DOCUMENT.Update' type='Item'}}">
                  <i class="fas fa-edit"></i>
                </a>
                <a class="item-delete" title="{{localize 'DOCUMENT.Delete' type='Item'}}">
                  <i class="fas fa-trash"></i>
                </a>
              </div>
            </div>
          {{/each}}
        </div>

      </div>
    </div>

    {{!-- Biography Tab --}}
    <div class="tab biography" data-group="primary" data-tab="description">
      <prose-mirror name="system.biography" value="{{system.biography}}" compact>
        {{{enrichedBiography}}}
      </prose-mirror>
    </div>

    {{!-- Owned Items Tab --}}
    <div class="tab items" data-group="primary" data-tab="items">
       {{> "systems/aspects-of-power/templates/actor/parts/actor-items.hbs"}}
    </div>

    {{!-- Owned Skills Tab --}}
    <div class="tab skills" data-group="primary" data-tab="skills">
      {{> "systems/aspects-of-power/templates/actor/parts/actor-skills.hbs"}}
    </div>

    {{!-- Active Effects Tab --}}
    <div class="tab effects flexcol" data-group="primary" data-tab="effects">
      {{> "systems/aspects-of-power/templates/actor/parts/actor-effects.hbs"}}
    </div>

  </section>
</form>
